import pandas as pd

# Input file
input_file = 'code.txt'
# Output file
output_file = 'output_123.xlsx'

# Initialize an empty list to store the parsed data
parsed_data = []

# Open the input file and read the contents
with open(input_file, 'r') as f:
    lines = f.readlines()

# Initialize variables
transaction_type = ''
create_time = ''

i = 0
while i < len(lines):
    line = lines[i].strip()

    # Check for Transaction Type
    if line.startswith('a123-apb-transactions-v2') or line.startswith('360ch_nobook_txn_retry'):
        transaction_type = line

    # Capture CreateTime
    elif line.startswith('CreateTime:'):
        create_time = line.split(':', 1)[1].strip()

    # Check for JSON-like structures
    elif line.startswith('{'):
        # Collect the entire JSON-like section
        json_data = line
        i += 1  # Move to next line

        # Continue collecting until we reach the closing brace
        while i < len(lines):
            json_line = lines[i].strip()
            json_data += json_line
            if json_line.endswith('}'):
                break
            i += 1  # Move to next line

        # Clean up data for parsing
        json_data_cleaned = json_data.replace('\n', '').replace('""', '"').strip()

        # Parsing Key-Value Pairs
        key_value_pairs = json_data_cleaned.replace('{', '').replace('}', '').split(',')
        
        for pair in key_value_pairs:
            pair = pair.strip()
            if ':' in pair:
                key, value = [p.strip().strip('"') for p in pair.split(':', 1)]
                if value.lower() == 'null':
                    value = None  # Convert "null" to None for clarity

                parsed_data.append({
                    'Transaction Type': transaction_type,
                    'CreateTime': create_time,
                    'Key': key,
                    'Value': value
                })

    i += 1  # Move to next line

# Write the parsed data to the output file
if parsed_data:
    df = pd.DataFrame(parsed_data)
    df.to_excel(output_file, index=False)
    print(f"✅ Data successfully saved to {output_file}")
else:
    print("❌ No valid transactions found. Check the input file for errors.")
